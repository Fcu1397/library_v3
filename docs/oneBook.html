<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>書籍詳情</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #1a1a1a;
            --accent: #d32f2f;
            --bg: #f9f9f9;
            --border-color: #000;
            --gray: #666;
            --light-gray: #e5e5e5;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg); color: var(--primary); padding-bottom: 80px;}
        a { text-decoration: none; color: inherit; transition: 0.2s; }
        ul { list-style: none; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 0 40px; height: 80px; background: #fff; border-bottom: 2px solid var(--border-color); position: sticky; top: 0; z-index: 100; }
        .header__logo { font-family: 'Noto Serif TC', serif; font-size: 24px; font-weight: 700; letter-spacing: 2px; }
        .header__search { flex: 1; max-width: 500px; margin: 0 20px; }
        .header__search input { width: 100%; padding: 10px 15px; border: 1px solid var(--primary); border-radius: 50px; background: #f0f0f0; }
        .header__actions { display: flex; align-items: center; gap: 20px; font-weight: 500; }
        .user-profile a { font-weight: 500; cursor: pointer; transition: 0.3s; }
        .user-profile a:hover { opacity: 0.7; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .loading-placeholder { text-align: center; padding: 80px; font-size: 20px; color: var(--gray); }
        .nav-bar { margin: 30px 0; display: flex; align-items: center; }
        .back-btn { display: inline-flex; align-items: center; gap: 10px; font-weight: 700; font-size: 16px; cursor: pointer; }
        .back-btn:hover { color: var(--gray); transform: translateX(-5px); }
        .book-hero { display: grid; grid-template-columns: 350px 1fr; gap: 50px; margin-bottom: 60px; background: #fff; padding: 40px; border: 1px solid var(--border-color); box-shadow: 10px 10px 0 rgba(0,0,0,0.05); }
        .book-cover { width: 100%; aspect-ratio: 2/3; background: #eee; position: relative; border: 1px solid #ddd; }
        .book-cover img { width: 100%; height: 100%; object-fit: cover; }
        .book-details { position: relative; display: flex; flex-direction: column; }
        .book-header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; border-bottom: 2px solid var(--primary); padding-bottom: 20px; }
        .book-title-group { flex: 1; margin-right: 20px; }
        .book-title { font-family: 'Noto Serif TC', serif; font-size: 32px; font-weight: 700; line-height: 1.3; margin-bottom: 10px; }
        .book-author { font-size: 18px; color: var(--gray); font-weight: 500; }
        .rating-box { background: var(--primary); color: #fff; padding: 10px 15px; text-align: center; min-width: 80px; }
        .rating-score { font-size: 24px; font-weight: 700; display: block; }
        .rating-stars { font-size: 10px; color: #FFD700; margin-top: 5px; }
        .meta-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px 30px; margin-bottom: 30px; font-size: 14px; }
        .meta-item { display: flex; }
        .meta-label { font-weight: 700; width: 80px; color: var(--gray); }
        .meta-value { font-weight: 500; }
        .tags-row { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 30px; }
        .tag { font-size: 12px; padding: 6px 12px; border: 1px solid var(--primary); background: #fff; font-weight: 700; cursor: pointer; transition: 0.2s; box-shadow: 2px 2px 0 var(--primary); }
        .tag:hover { transform: translate(-1px, -1px); box-shadow: 4px 4px 0 var(--primary); }
        .book-desc { font-size: 15px; line-height: 1.8; color: #444; background: #f4f4f4; padding: 20px; border-left: 4px solid var(--primary); margin-top: auto; }
        .section-block { margin-bottom: 60px; }
        .section-head { font-size: 24px; font-family: 'Noto Serif TC', serif; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; }
        .section-head::before { content: ''; display: inline-block; width: 8px; height: 24px; background: var(--accent); margin-right: 15px; }
        .holdings-table { width: 100%; border-collapse: collapse; background: #fff; border: 1px solid var(--primary); }
        .holdings-table th { background: var(--primary); color: #fff; padding: 15px; text-align: left; font-weight: 500; letter-spacing: 1px; }
        .holdings-table td { padding: 20px 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .holdings-table tr:last-child td { border-bottom: none; }
        .status { font-weight: 700; display: inline-flex; align-items: center; gap: 6px; }
        .status.available { color: #2e7d32; }
        .status.loaned { color: #c62828; }
        .due-date { font-weight: 400; font-size: 13px; color: var(--gray); margin-left: 5px; }
        .btn-action { background: transparent; border: 1px solid var(--primary); padding: 8px 20px; font-weight: 700; cursor: pointer; transition: 0.2s; }
        .btn-action:hover { background: var(--primary); color: #fff; }
        .btn-action:disabled { background: #ccc; border-color: #ccc; color: #555; cursor: not-allowed; }
        .review-list { display: flex; flex-direction: column; gap: 20px; }
        .review-card { background: #fff; border: 1px solid #ddd; padding: 20px; display: flex; gap: 20px; }
        .review-avatar { width: 50px; height: 50px; background: #eee; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 20px; color: var(--gray); }
        .review-content { flex: 1; }
        .review-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .reviewer-name { font-weight: 700; font-size: 16px; }
        .review-stars { color: #FFD700; letter-spacing: 2px; }
        .review-text { font-size: 15px; line-height: 1.6; color: #333; margin-bottom: 15px; }
        .review-footer { display: flex; justify-content: flex-end; }
        .like-btn { cursor: pointer; color: var(--gray); font-size: 14px; display: flex; align-items: center; gap: 6px; transition: 0.2s; }
        .like-btn:hover { color: var(--accent); }
        .btn-fav {
            margin-top: 15px;
            padding: 10px 20px;
            border: 1px solid var(--primary);
            background: #fff;
            cursor: pointer;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
        }
        .btn-fav:hover { background: #f4f4f4; }
        .btn-fav.active { background: var(--primary); color: #fff; }
        @media (max-width: 768px) { .book-hero { grid-template-columns: 1fr; } .meta-grid { grid-template-columns: 1fr; } .holdings-table th, .holdings-table td { padding: 10px; font-size: 14px; } }
    </style>
</head>
<body>

<header class="header">
    <a href="index.html" class="header__logo">LIBRARY.SYS</a>
    <div class="header__search">
        <input type="text" placeholder="搜尋書名...">
    </div>
    <div class="header__actions">
        <!-- Auth content is injected here by auth.js -->
    </div>
</header>

<div class="container" id="main-container">
    <div class="loading-placeholder">
        <i class="fa-solid fa-spinner fa-spin"></i> 載入中...
    </div>
</div>

<script src="js/db.js"></script>
<script src="js/api.js"></script>
<script src="js/auth.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const mainContainer = document.getElementById('main-container');
    const urlParams = new URLSearchParams(window.location.search);
    const bookId = urlParams.get('id');

    let bookData = null;
    let userData = null;

    const render = () => {
        if (!bookData || !userData) return;

        const book = bookData;
        const currentUser = userData;
        document.title = '書籍詳情 - ' + book.title;

        const generateStars = (rating) => {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (rating >= i) stars += '<i class="fa-solid fa-star"></i>';
                else if (rating >= i - 0.5) stars += '<i class="fa-solid fa-star-half-stroke"></i>';
                else stars += '<i class="fa-regular fa-star"></i>';
            }
            return stars;
        };

        const isAlreadyReserved = currentUser.reservations.some(r => r.bookId === book.id);
        const isFavorited = currentUser.favorites.some(f => f.bookId === book.id);
        const isBorrowedByUser = (holdingId) => currentUser.loans.some(l => l.holdingId === holdingId);

        const holdingsHTML = book.holdings.map(holding => {
            let statusHTML, actionHTML = '';

            if (isBorrowedByUser(holding.id)) {
                statusHTML = '<span class="status loaned"><i class="fa-solid fa-check"></i> 您已借閱</span>';
                actionHTML = '<button class="btn-action" disabled>還書</button>'; // Placeholder for return functionality
            } else if (holding.status === 'available') {
                statusHTML = '<span class="status available"><i class="fa-solid fa-circle-check"></i> 在館</span>';
                actionHTML = '<button class="btn-action btn-borrow" data-book-id="' + book.id + '" data-holding-id="' + holding.id + '">借閱</button>';
            } else { // loaned by someone else
                statusHTML = '<span class="status loaned"><i class="fa-solid fa-circle-xmark"></i> 外借中</span><span class="due-date">( ' + holding.dueDate + ' 到期)</span>';
                actionHTML = isAlreadyReserved
                    ? '<button class="btn-action" disabled>已預約</button>'
                    : '<button class="btn-action btn-reserve" data-book-id="' + book.id + '">預約</button>';
            }

            return '<tr><td>' + holding.id + '</td><td>' + holding.location + '</td><td>' + statusHTML + '</td><td>' + actionHTML + '</td></tr>';
        }).join('');

        const reviewsHTML = book.reviews.length > 0 ? book.reviews.map(review => {
            return '<div class="review-card">' +
                '<div class="review-avatar">' + review.user.charAt(0).toUpperCase() + '</div>' +
                '<div class="review-content">' +
                    '<div class="review-header">' +
                        '<span class="reviewer-name">' + review.user + '</span>' +
                        '<div class="review-stars">' + generateStars(review.stars) + '</div>' +
                    '</div>' +
                    '<p class="review-text">' + review.comment + '</p>' +
                '</div>' +
            '</div>';
        }).join('') : '<p>暫無評論。</p>';

        const favBtnHTML = isFavorited
            ? '<button class="btn-fav active" id="btn-fav"><i class="fa-solid fa-heart"></i> 已收藏</button>'
            : '<button class="btn-fav" id="btn-fav"><i class="fa-regular fa-heart"></i> 加入收藏</button>';

        mainContainer.innerHTML =
            '<nav class="nav-bar"><a href="javascript:history.back()" class="back-btn"><i class="fa-solid fa-arrow-left-long"></i> 返回上一頁</a></nav>' +
            '<section class="book-hero">' +
                '<div class="book-cover"><img src="' + book.cover + '" alt="' + book.title + '"></div>' +
                '<div class="book-details">' +
                    '<div class="book-header-row">' +
                        '<div class="book-title-group"><h1 class="book-title">' + book.title + '</h1><div class="book-author">作者：' + book.author + '</div></div>' +
                        '<div class="rating-box"><span class="rating-score">' + book.rating + '</span><div class="rating-stars">' + generateStars(book.rating) + '</div></div>' +
                    '</div>' +
                    '<div class="meta-grid">' +
                        '<div class="meta-item"><span class="meta-label">主類別</span> <span class="meta-value">' + book.categoryMain + '</span></div>' +
                        '<div class="meta-item"><span class="meta-label">次類別</span> <span class="meta-value">' + book.categorySub + '</span></div>' +
                        '<div class="meta-item"><span class="meta-label">出版商</span> <span class="meta-value">' + book.publisher + '</span></div>' +
                        '<div class="meta-item"><span class="meta-label">ISBN</span> <span class="meta-value">' + book.isbn + '</span></div>' +
                    '</div>' +
                    '<div class="tags-row">' + book.tags.map(tag => '<span class="tag"># ' + tag + '</span>').join('') + '</div>' +
                    '<div class="book-desc"><p>' + book.description + '</p></div>' +
                    '<div>' + favBtnHTML + '</div>' +
                '</div>' +
            '</section>' +
            '<section class="section-block">' +
                '<h2 class="section-head">書籍狀況 / HOLDINGS</h2>' +
                '<table class="holdings-table"><thead><tr><th width="15%">編號</th><th width="20%">館藏地</th><th width="40%">狀態</th><th width="25%">操作</th></tr></thead><tbody>' + holdingsHTML + '</tbody></table>' +
            '</section>' +
            '<section class="section-block">' +
                '<h2 class="section-head">讀者評論 / REVIEWS</h2>' +
                '<div class="review-list">' + reviewsHTML + '</div>' +
            '</section>';

        addEventListeners();
    };

    const addEventListeners = () => {
        // Event delegation for action buttons
        mainContainer.addEventListener('click', async (e) => {
            const button = e.target.closest('.btn-action');
            if (button) {
                button.disabled = true;
                button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

                try {
                    if (button.classList.contains('btn-borrow')) {
                        const { bookId, holdingId } = button.dataset;
                        const result = await LibraryAPI.borrowBook(bookId, holdingId);
                        alert(result.message);
                    } else if (button.classList.contains('btn-reserve')) {
                        const { bookId } = button.dataset;
                        const result = await LibraryAPI.reserveBook(bookId);
                        alert(result.message);
                    }
                    // Refresh data and re-render after any action
                    await loadData(false); // false to prevent full page flicker
                } catch (error) {
                    alert('操作失敗：' + error.message);
                    // Re-enable button on failure
                    button.disabled = false;
                    if (button.classList.contains('btn-borrow')) button.textContent = '借閱';
                    if (button.classList.contains('btn-reserve')) button.textContent = '預約';
                }
            }
        });

        // Favorite Button
        const favButton = document.getElementById('btn-fav');
        if (favButton) {
            favButton.addEventListener('click', async () => {
                try {
                    favButton.disabled = true;
                    const isFavorited = userData.favorites.some(f => f.bookId === bookData.id);

                    if (isFavorited) {
                        await LibraryAPI.removeFromFavorites(bookData.id);
                    } else {
                        await LibraryAPI.addToFavorites(bookData.id);
                    }

                    await loadData(false);
                } catch (error) {
                    alert('操作失敗：' + error.message);
                    favButton.disabled = false;
                }
            });
        }
    };

    const loadData = async (showLoading = true) => {
        if (showLoading) {
            mainContainer.innerHTML = '<div class="loading-placeholder"><i class="fa-solid fa-spinner fa-spin"></i> 載入中...</div>';
        }
        try {
            if (!bookId) {
                mainContainer.innerHTML = '<p class="loading-placeholder">無效的書籍 ID。</p>';
                return;
            }
            [bookData, userData] = await Promise.all([
                LibraryAPI.getBookById(bookId),
                LibraryAPI.getCurrentUser()
            ]);
            render();
        } catch (error) {
            mainContainer.innerHTML = '<p class="loading-placeholder">錯誤：' + error.message + '</p>';
        }
    };

    loadData();
});
</script>

</body>
</html>
